Usage of Podman container for PennyLane

details are here
https://docs.google.com/document/d/1LHYlTXtOyA5vZSrJF0IdZf3L88DcguMWXyHAPLV-MvU/edit?usp=sharing


Summary:
This is an instruction on how to build and use a Podman image.
The example consists of three parts:
A) Building the image, which I've already completed on PM.
B) Running the image on PM in three modes: simple interactive, advanced interactive, and a Slurm job that executes your code inside a podman image.
C) Running the same image on your laptop. You'll need to build it as described in A), but then running it is straightforward.



= = = 
A = = = = = = = = = =  building container (one time) = = = = = = = = =
= = = 
Dockerfile: Dockerfile.ubu22-PennyLane
Laptop: 
    podman build -f Dockerfile.ubu22-PennyLane -t balewski/ubu22-pennylane:p5   .
Perlmutter
   podman-hpc build -f Dockerfile.ubu22-PennyLane -t balewski/ubu22-pennylane:p5   .
   POD_PUB=/cfs/cdirs/nstaff/balewski/podman_common/
   podman-hpc --squash-dir /global/$POD_PUB migrate  balewski/ubu22-pennylane:p5
   chmod -R a+rx  /global/$POD_PUB   # to allow anyone to use this image
   
   Note,  the instruction above is for user:balewski who has access to CFS/nstaff - change the strings as needed



= = = 
B = = = = = = = = = =   Perlmutter @ NERSC = = = = = = = = =
= = = 

B.1  - - - - - -  simple interactive use  on a worker node - - - - - - - 

ssh perlmutter
export PS1="\h:\W> "  # to reduce too long names of directoriesexport PS1="\h:\W> "  # to reduce too long names of directories

POD_PUB=/cfs/cdirs/nstaff/balewski/podman_common/
export PODMANHPC_ADDITIONAL_STORES=/dvs_ro/$POD_PUB
cd  $SCRATCH/tmp
salloc -q interactive -C cpu -t 4:00:00 -A nstaff
podman-hpc run -it  balewski/ubu22-pennylane:p5 bash
 python3 -c 'import pennylane'
exit


B.2  - - - - - -  advanced interactive use  on a worker node - - - - - - - 
copy & customize  https://github.com/balewski/quantumMind/blob/main/PennyLane/pm_podman.source   
to configure shortcuts to your liking

ssh perlmutter
salloc -q interactive -C cpu -t 4:00:00 -A nstaff
source pm_podman.source 

[ do your work ]

exit  #from podman
exit # from salloc



B.3  - - - - - -  advanced : Slurm job with multiple task  using Podman image- - - - - - - 
  copy and customize https://github.com/balewski/quantumMind/tree/main/PennyLane/qml_intro/
batchPodman.slr
wrap_podman.sh
 
You will edit code stored  in CFS area but running job will read/write from/to SCRATCH using its copy.  Do NOT start Podman image manually

ssh perlmutter
ssh CFS  (to your area )
sbatch batchPodman.slr


B.4  - - - - - -  advanced :  install project spceciffic software, NOT recommended but possible

ssh pm

IMG=jbowles/ubu22-pennylane:p5
POD_PUB=/dvs_ro/cfs/cdirs/m4139/qml-benchmarks/nersc/podman/
export PODMANHPC_ADDITIONAL_STORES=$POD_PUB
CFSH=$SCRATCH/pennylane_wrk  # for Jan
#CFSH=/global/cfs/cdirs/m4139  # for Joseph
podman-hpc run -it --volume  $CFSH/qml-benchmarks:/root --workdir /root  $IMG  bash
pip3 install    --user .       # inside image, create private ./local

exit

Testing:
podman-hpc run -it  â€¦
python3 -u -c "import qml_benchmarks "
exit

AND when lanuching podman image you must have this volume mount, on the top of all other volumes you need:

 --volume  $CFSH/qml-benchmarks:/root 

B.5  - - - - - -  advanced : jupiter notebook on the laptop powered by Podman PennyLane image running on PM - - - - - - - 
  Easy to do 




= = = 
C = = = = = = = = = =   Laptop = = = = = = = = =
= = = 

C.1  - - - - - -  simple interactive use  on a laptop - - - - - - - 
$ podman run -it  balewski/ubu22-pennylane:p3 bash
 python3 -c 'import pennylane'
exit


C.2  - - - - - -  advanced w/ predefined volume mounts on a laptop  - - - - - - - 
copy & customize  https://github.com/balewski/quantumMind/blob/main/PennyLane/laptop_podman.source 
to configure shortcuts to your liking

source laptop_podman.source 

[ do your work ]

exit  #from podman

If you need to reset podman, do :   source restart_podman.source


C.4  - - - - - -  advanced : jupiter notebook on the laptop powered by Podman PennyLane image running on the laptop - - - - - - - 

source laptop_podman.source jnb 
(exec inside running image)  jupyter notebook --ip 0.0.0.0 --no-browser --allow-root --port  8833 
copy http  string and paste into local browser , e.g:   http://127.0.0.1:8833/tree?token=7c5cdf5e5c4f1a9d2a616a739988132d59f1a7ca3f4c0779

Troubleshooting: if JNB remains blank change port ID in  laptop_podman.source  and restart the image
